<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Seguimiento de Prácticas Laborales - Facultad de Ingenierías, Tecnologías e Innovación</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css' rel='stylesheet'>
    <style>
        body { padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dataTables_wrapper { padding: 20px 0; }
        .container-fluid { max-width: 100%; overflow-x: auto; }
        .estado-no-comienza { background-color: #ffcccc; color: #990000; }
        .estado-en-proceso { background-color: #ffffcc; color: #999900; }
        .estado-completada { background-color: #ccffcc; color: #009900; }
        .evaluacion-excelente { color: #009900; }
        .evaluacion-malo { color: #990000; }
        .chart-container { height: 400px; margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class='container-fluid'>
        <h1 class='text-center mb-4'>Seguimiento de Prácticas Laborales - Facultad de Ingenierías, Tecnologías e Innovación</h1>
        <table id='seguimientoPracticas' class='table table-striped table-bordered'>
            <thead>
                <tr>
                    <th>Nombre y Apellidos</th>
                    <th>RUT</th>
                    <th>Carrera</th>
                    <th>SEDE</th>
                    <th>Nombre Centro de práctica</th>
                    <th>Nombre instructor</th>
                    <th>Fecha de Inicio</th>
                    <th>Fecha de Término</th>
                    <th>Seguimiento 1</th>
                    <th>Evaluación parcial</th>
                    <th>Seguimiento 2</th>
                    <th>Revisión de avance</th>
                    <th>Evaluación instructor</th>
                    <th>Documentación instructor</th>
                    <th>Finalización práctica</th>
                    <th>Documentación finalización</th>
                    <th>Asignación hora examen título</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas se generarán dinámicamente aquí -->
            </tbody>
        </table>
        <div class='text-center mt-3'>
            <button id='exportButton' class='btn btn-primary'>Exportar a Excel</button>
            <button id='saveButton' class='btn btn-success'>Guardar</button>
        </div>
        <div class='row mt-4'>
            <div class='col-md-4'>
                <div class='chart-container'>
                    <canvas id='estadosPracticasChart'></canvas>
                </div>
            </div>
            <div class='col-md-4'>
                <div class='chart-container'>
                    <canvas id='sedesChart'></canvas>
                </div>
            </div>
            <div class='col-md-4'>
                <div class='chart-container'>
                    <canvas id='carrerasChart'></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js'></script>
    <script src='https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/flatpickr'></script>
    <script src='https://npmcdn.com/flatpickr/dist/l10n/es.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js'></script>

    <script>
        const carreras = [
            'Técnico De Nivel Superior En Administración De Empresas',
            'Técnico De Nivel Superior En Agronomía',
            'Técnico De Nivel Superior En Automatización Y Control Industrial',
            'Técnico De Nivel Superior En Construcción',
            'Técnico De Nivel Superior En Electricidad',
            'Técnico De Nivel Superior En Mantenimiento Industrial',
            'Técnico De Nivel Superior En Mecánica Industrial',
            'Técnico De Nivel Superior En Minas',
            'Técnico De Nivel Superior En Minería Y Metalurgia',
            'Técnico Nivel Superior En Construcción Y Obras Civiles'
        ];

        const sedes = ['Ancud', 'Calama', 'Los Andes', 'San Felipe', 'Machali'];

        function crearSelectCarrera(valorSeleccionado = '') {
            return `<select class='form-select carrera-select'>
                ${carreras.map(carrera => `<option value='${carrera}' ${carrera === valorSeleccionado ? 'selected' : ''}>${carrera}</option>`).join('')}
            </select>`;
        }

        function crearSelectEstado(valorSeleccionado = '') {
            return `<select class='form-select estado-select'>
                <option value='no-comienza' class='estado-no-comienza' ${valorSeleccionado === 'no-comienza' ? 'selected' : ''}>No comienza</option>
                <option value='en-proceso' class='estado-en-proceso' ${valorSeleccionado === 'en-proceso' ? 'selected' : ''}>En proceso</option>
                <option value='completada' class='estado-completada' ${valorSeleccionado === 'completada' ? 'selected' : ''}>Completada</option>
            </select>`;
        }

        function crearSelectEvaluacion(valorSeleccionado = '') {
            return `<select class='form-select evaluacion-select'>
                <option value='excelente' class='evaluacion-excelente' ${valorSeleccionado === 'excelente' ? 'selected' : ''}>Excelente</option>
                <option value='bien' ${valorSeleccionado === 'bien' ? 'selected' : ''}>Bien</option>
                <option value='suficiente' ${valorSeleccionado === 'suficiente' ? 'selected' : ''}>Suficiente</option>
                <option value='deficiente' ${valorSeleccionado === 'deficiente' ? 'selected' : ''}>Deficiente</option>
                <option value='malo' class='evaluacion-malo' ${valorSeleccionado === 'malo' ? 'selected' : ''}>Malo</option>
            </select>`;
        }

        function crearSelectSede(valorSeleccionado = '') {
            return `<select class='form-select sede-select'>
                ${sedes.map(sede => `<option value='${sede}' ${sede === valorSeleccionado ? 'selected' : ''}>${sede}</option>`).join('')}
            </select>`;
        }

        function generarFilas() {
            let tbody = $('#seguimientoPracticas tbody');
            const datosGuardados = JSON.parse(localStorage.getItem('datosPracticas')) || [];

            if (datosGuardados.length > 0) {
                datosGuardados.forEach(fila => {
                    tbody.append(crearFila(fila));
                });
            } else {
                for (let i = 0; i < 100; i++) {
                    tbody.append(crearFila());
                }
            }
        }

        function crearFila(datos = {}) {
            return `
                <tr>
                    <td><input type='text' class='form-control' value='${datos.nombre || ''}'></td>
                    <td><input type='text' class='form-control' value='${datos.rut || ''}'></td>
                    <td>${crearSelectCarrera(datos.carrera)}</td>
                    <td>${crearSelectSede(datos.sede)}</td>
                    <td><input type='text' class='form-control' value='${datos.centroPractica || ''}'></td>
                    <td><input type='text' class='form-control' placeholder='Nombre del instructor' value='${datos.instructor || ''}'></td>
                    <td><input type='text' class='form-control datepicker' value='${datos.fechaInicio || ''}'></td>
                    <td><input type='text' class='form-control datepicker' value='${datos.fechaTermino || ''}'></td>
                    <td>${crearSelectEstado(datos.seguimiento1)}</td>
                    <td>${crearSelectEvaluacion(datos.evaluacionParcial)}</td>
                    <td>${crearSelectEstado(datos.seguimiento2)}</td>
                    <td>${crearSelectEvaluacion(datos.revisionAvance)}</td>
                    <td>${crearSelectEvaluacion(datos.evaluacionInstructor)}</td>
                    <td><button class='btn btn-primary btn-sm adjuntar-doc'>Adjuntar documentación</button></td>
                    <td>${crearSelectEstado(datos.finalizacionPractica)}</td>
                    <td><button class='btn btn-primary btn-sm adjuntar-doc'>Adjuntar documentación</button></td>
                    <td>${crearSelectEstado(datos.asignacionHoraExamen)}</td>
                </tr>
            `;
        }

        let estadosChart, carrerasChart, sedesChart;

        function actualizarGraficos() {
            actualizarGraficoEstados();
            actualizarGraficoCarreras();
            actualizarGraficoSedes();
        }

        function actualizarGraficoEstados() {
            let estados = {
                'no-comienza': 0,
                'en-proceso': 0,
                'completada': 0
            };

            $('.estado-select').each(function() {
                estados[$(this).val()]++;
            });

            if (estadosChart) {
                estadosChart.data.datasets[0].data = [estados['no-comienza'], estados['en-proceso'], estados['completada']];
                estadosChart.update();
            } else {
                const ctx = document.getElementById('estadosPracticasChart').getContext('2d');
                estadosChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['No comienza', 'En proceso', 'Completada'],
                        datasets: [{
                            label: 'Estados de Prácticas',
                            data: [estados['no-comienza'], estados['en-proceso'], estados['completada']],
                            backgroundColor: ['#ffcccc', '#ffffcc', '#ccffcc']
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }
        }

        function actualizarGraficoCarreras() {
            let conteoCarreras = {};
            carreras.forEach(carrera => conteoCarreras[carrera] = 0);

            $('.carrera-select').each(function() {
                let carrera = $(this).val();
                if (conteoCarreras[carrera] !== undefined) {
                    conteoCarreras[carrera]++;
                }
            });

            const datos = carreras.map(carrera => conteoCarreras[carrera]);
            const colores = datos.map(() => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`);

            if (carrerasChart) {
                carrerasChart.data.datasets[0].data = datos;
                carrerasChart.data.datasets[0].backgroundColor = colores;
                carrerasChart.update();
            } else {
                const ctx = document.getElementById('carrerasChart').getContext('2d');
                carrerasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: carreras,
                        datasets: [{
                            label: 'Número de Estudiantes por Carrera',
                            data: datos,
                            backgroundColor: colores
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                title: { display: true, text: 'Carreras' },
                                ticks: { 
                                    autoSkip: false,
                                    maxRotation: 90,
                                    minRotation: 90,
                                    callback: function(value, index) {
                                        return this.getLabelForValue(value).split(' ').slice(0, 3).join(' ');
                                    }
                                }
                            },
                            y: { 
                                title: { display: true, text: 'Número de Estudiantes' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoSedes() {
            let conteoSedes = {};
            sedes.forEach(sede => conteoSedes[sede] = 0);

            $('.sede-select').each(function() {
                let sede = $(this).val();
                if (conteoSedes[sede] !== undefined) {
                    conteoSedes[sede]++;
                }
            });

            if (sedesChart) {
                sedesChart.data.datasets[0].data = sedes.map(sede => conteoSedes[sede]);
                sedesChart.update();
            } else {
                const ctx = document.getElementById('sedesChart').getContext('2d');
                sedesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sedes,
                        datasets: [{
                            label: 'Estudiantes por Sede',
                            data: sedes.map(sede => conteoSedes[sede]),
                            backgroundColor: sedes.map(() => `hsl(${Math.random() * 360}, 70%, 70%)`)
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: true,
                                text: 'Distribución de Estudiantes por Sede'
                            }
                        }
                    }
                });
            }
        }

        $(document).ready(function() {
            generarFilas();

            $('#seguimientoPracticas').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json'
                },
                pageLength: 25
            });

            flatpickr('.datepicker', {
                dateFormat: 'd-m-Y',
                locale: 'es'
            });

            actualizarGraficos();

            $('#seguimientoPracticas').on('change', 'select, input', function() {
                actualizarGraficos();
            });

            $('#exportButton').click(function() {
                let data = [];
                $('#seguimientoPracticas tbody tr').each(function() {
                    let row = [];
                    $(this).find('input, select').each(function() {
                        row.push($(this).val());
                    });
                    data.push(row);
                });

                let wb = XLSX.utils.book_new();
                let ws = XLSX.utils.aoa_to_sheet([
                    ['Nombre y Apellidos', 'RUT', 'Carrera', 'SEDE', 'Nombre Centro de práctica', 'Nombre instructor', 'Fecha de Inicio', 'Fecha de Término', 'Seguimiento 1', 'Evaluación parcial', 'Seguimiento 2', 'Revisión de avance', 'Evaluación instructor', 'Finalización práctica', 'Asignación hora examen título'],
                    ...data
                ]);
                XLSX.utils.book_append_sheet(wb, ws, 'Seguimiento Prácticas');
                XLSX.writeFile(wb, 'SeguimientoPracticas.xlsx');
            });

            $('#saveButton').click(function() {
                let datos = [];
                $('#seguimientoPracticas tbody tr').each(function() {
                    let fila = {};
                    fila.nombre = $(this).find('td:eq(0) input').val();
                    fila.rut = $(this).find('td:eq(1) input').val();
                    fila.carrera = $(this).find('td:eq(2) select').val();
                    fila.sede = $(this).find('td:eq(3) select').val();
                    fila.centroPractica = $(this).find('td:eq(4) input').val();
                    fila.instructor = $(this).find('td:eq(5) input').val();
                    fila.fechaInicio = $(this).find('td:eq(6) input').val();
                    fila.fechaTermino = $(this).find('td:eq(7) input').val();
                    fila.seguimiento1 = $(this).find('td:eq(8) select').val();
                    fila.evaluacionParcial = $(this).find('td:eq(9) select').val();
                    fila.seguimiento2 = $(this).find('td:eq(10) select').val();
                    fila.revisionAvance = $(this).find('td:eq(11) select').val();
                    fila.evaluacionInstructor = $(this).find('td:eq(12) select').val();
                    fila.finalizacionPractica = $(this).find('td:eq(14) select').val();
                    fila.asignacionHoraExamen = $(this).find('td:eq(16) select').val();
                    datos.push(fila);
                });
                localStorage.setItem('datosPracticas', JSON.stringify(datos));
                alert('Datos guardados con éxito');
            });

            $(document).on('click', '.adjuntar-doc', function() {
                let input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf,.doc,.docx';
                input.onchange = e => {
                    let file = e.target.files[0];
                    let fileName = file.name;
                    $(this).text(fileName);
                    // Aquí puedes agregar la lógica para subir el archivo a un servidor
                    alert(`Archivo "${fileName}" adjuntado. (Simulación: el archivo no se ha subido realmente)`);
                };
                input.click();
            });
        });
    </script>
</body>
</html>

