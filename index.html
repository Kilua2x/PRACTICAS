<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Seguimiento de Prácticas Laborales - Facultad de Ingenierías, Tecnologías e Innovación</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css' rel='stylesheet'>
    <style>
        body { padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dataTables_wrapper { padding: 20px 0; }
        .container-fluid { max-width: 100%; overflow-x: auto; }
        .estado-no-comienza { background-color: #ffcccc; color: #990000; }
        .estado-en-proceso { background-color: #ffffcc; color: #999900; }
        .estado-completada { background-color: #ccffcc; color: #009900; }
        .evaluacion-excelente { color: #009900; }
        .evaluacion-malo { color: #990000; }
        .chart-container { height: 400px; margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class='container-fluid'>
        <h1 class='text-center mb-4'>Seguimiento de Prácticas Laborales - Facultad de Ingenierías, Tecnologías e Innovación</h1>
        <table id='seguimientoPracticas' class='table table-striped table-bordered'>
            <thead>
                <tr>
                    <th>Nombre y Apellidos</th>
                    <th>RUT</th>
                    <th>Carrera</th>
                    <th>SEDE</th>
                    <th>Nombre instructor</th>
                    <th>Fecha de Inicio</th>
                    <th>Fecha de Término</th>
                    <th>Seguimiento 1</th>
                    <th>Evaluación parcial</th>
                    <th>Seguimiento 2</th>
                    <th>Revisión de avance</th>
                    <th>Evaluación instructor</th>
                    <th>Finalización práctica</th>
                    <th>Asignación hora examen título</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas se generarán dinámicamente aquí -->
            </tbody>
        </table>
        <div class='text-center mt-3'>
            <button id='exportButton' class='btn btn-primary'>Exportar a Excel</button>
            <button id='saveButton' class='btn btn-success'>Guardar</button>
        </div>
        <div class='row mt-4'>
            <div class='col-md-4'>
                <div class='chart-container'>
                    <canvas id='estadosPracticasChart'></canvas>
                </div>
            </div>
            <div class='col-md-4'>
                <div class='chart-container'>
                    <canvas id='sedesChart'></canvas>
                </div>
            </div>
            <div class='col-md-4'>
                <div class='chart-container'>
                    <canvas id='carrerasChart'></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js'></script>
    <script src='https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/flatpickr'></script>
    <script src='https://npmcdn.com/flatpickr/dist/l10n/es.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>

    <script>
        const carreras = [
            'Técnico en Enfermería', 'Técnico en Administración', 'Técnico en Informática',
            'Técnico en Contabilidad', 'Técnico en Electricidad', 'Técnico en Mecánica Automotriz',
            'Técnico en Construcción', 'Técnico en Diseño Gráfico', 'Técnico en Gastronomía',
            'Técnico en Turismo'
        ];

        const sedes = ['Ancud', 'Calama', 'Los Andes', 'San Felipe', 'Machali'];

        function generarRUTChileno() {
            let rut = Math.floor(Math.random() * 30000000) + 5000000;
            let dv = 11 - (rut % 11);
            if (dv === 11) dv = 0;
            if (dv === 10) dv = 'K';
            return rut + '-' + dv;
        }

        function generarNombreApellido() {
            const nombres = ['Juan', 'María', 'Pedro', 'Ana', 'Luis', 'Carmen', 'José', 'Isabel', 'Francisco', 'Sofía'];
            const apellidos = ['González', 'Rodríguez', 'Fernández', 'López', 'Martínez', 'Pérez', 'Gómez', 'Sánchez', 'Díaz', 'Torres'];
            return nombres[Math.floor(Math.random() * nombres.length)] + ' ' + 
                   apellidos[Math.floor(Math.random() * apellidos.length)] + ' ' + 
                   apellidos[Math.floor(Math.random() * apellidos.length)];
        }

        function crearSelectEstado() {
            return `<select class='form-select estado-select'>
                <option value='no-comienza' class='estado-no-comienza'>No comienza</option>
                <option value='en-proceso' class='estado-en-proceso'>En proceso</option>
                <option value='completada' class='estado-completada'>Completada</option>
            </select>`;
        }

        function crearSelectEvaluacion() {
            return `<select class='form-select evaluacion-select'>
                <option value='excelente' class='evaluacion-excelente'>Excelente</option>
                <option value='bien'>Bien</option>
                <option value='suficiente'>Suficiente</option>
                <option value='deficiente'>Deficiente</option>
                <option value='malo' class='evaluacion-malo'>Malo</option>
            </select>`;
        }

        function crearSelectSede() {
            return `<select class='form-select sede-select'>
                ${sedes.map(sede => `<option value='${sede}'>${sede}</option>`).join('')}
            </select>`;
        }

        function generarFilas() {
            let tbody = $('#seguimientoPracticas tbody');
            for (let i = 0; i < 100; i++) {
                tbody.append(`
                    <tr>
                        <td><input type='text' class='form-control' value='${generarNombreApellido()}'></td>
                        <td><input type='text' class='form-control' value='${generarRUTChileno()}'></td>
                        <td><input type='text' class='form-control carrera-input' value='${carreras[Math.floor(Math.random() * carreras.length)]}'></td>
                        <td>${crearSelectSede()}</td>
                        <td><input type='text' class='form-control' placeholder='Nombre del instructor'></td>
                        <td><input type='text' class='form-control datepicker'></td>
                        <td><input type='text' class='form-control datepicker'></td>
                        <td>${crearSelectEstado()}</td>
                        <td>${crearSelectEvaluacion()}</td>
                        <td>${crearSelectEstado()}</td>
                        <td>${crearSelectEvaluacion()}</td>
                        <td>${crearSelectEvaluacion()}</td>
                        <td>${crearSelectEstado()}</td>
                        <td>${crearSelectEstado()}</td>
                    </tr>
                `);
            }
        }

        let estadosChart, carrerasChart, sedesChart;

        function actualizarGraficos() {
            actualizarGraficoEstados();
            actualizarGraficoCarreras();
            actualizarGraficoSedes();
        }

        function actualizarGraficoEstados() {
            let estados = {
                'no-comienza': 0,
                'en-proceso': 0,
                'completada': 0
            };

            $('.estado-select').each(function() {
                estados[$(this).val()]++;
            });

            if (estadosChart) {
                estadosChart.data.datasets[0].data = [estados['no-comienza'], estados['en-proceso'], estados['completada']];
                estadosChart.update();
            } else {
                const ctx = document.getElementById('estadosPracticasChart').getContext('2d');
                estadosChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['No comienza', 'En proceso', 'Completada'],
                        datasets: [{
                            label: 'Estados de Prácticas',
                            data: [estados['no-comienza'], estados['en-proceso'], estados['completada']],
                            backgroundColor: ['#ffcccc', '#ffffcc', '#ccffcc']
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }
        }

        function actualizarGraficoCarreras() {
            let conteoCarreras = {};
            carreras.forEach(carrera => conteoCarreras[carrera] = 0);

            $('.carrera-input').each(function() {
                let carrera = $(this).val();
                if (conteoCarreras[carrera] !== undefined) {
                    conteoCarreras[carrera]++;
                }
            });

            if (carrerasChart) {
                carrerasChart.data.datasets[0].data = carreras.map(carrera => conteoCarreras[carrera]);
                carrerasChart.update();
            } else {
                const ctx = document.getElementById('carrerasChart').getContext('2d');
                carrerasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: carreras,
                        datasets: [{
                            label: 'Número de Estudiantes por Carrera',
                            data: carreras.map(carrera => conteoCarreras[carrera]),
                            backgroundColor: '#42A5F5'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                title: { display: true, text: 'Carreras' },
                                ticks: { autoSkip: false, maxRotation: 90, minRotation: 45 }
                            },
                            y: { 
                                title: { display: true, text: 'Número de Estudiantes' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoSedes() {
            let conteoSedes = {};
            sedes.forEach(sede => conteoSedes[sede] = 0);

            $('.sede-select').each(function() {
                let sede = $(this).val();
                if (conteoSedes[sede] !== undefined) {
                    conteoSedes[sede]++;
                }
            });

            if (sedesChart) {
                sedesChart.data.datasets[0].data = sedes.map(sede => conteoSedes[sede]);
                sedesChart.update();
            } else {
                const ctx = document.getElementById('sedesChart').getContext('2d');
                sedesChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: sedes,
                        datasets: [{
                            label: 'Participación por Sede',
                            data: sedes.map(sede => conteoSedes[sede]),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }
        }

        $(document).ready(function() {
            generarFilas();
            $('#seguimientoPracticas').DataTable({
                'pageLength': 10,
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: 'Exportar a Excel',
                        filename: 'seguimiento_practicas',
                        exportOptions: {
                            columns: ':visible',
                            format: {
                                body: function ( data, row, column, node ) {
                                    // Verifica si el contenido es un select o un input
                                    if ($(node).find('select').length > 0) {
                                        return $(node).find('select').val();
                                    } else if ($(node).find('input').length > 0) {
                                        return $(node).find('input').val();
                                    }
                                    return data;
                                }
                            }
                        }
                    }
                ],
                columnDefs: [
                    { targets: [0, 1, 2], searchable: false }
                ]
            });

            $('.datepicker').flatpickr({
                locale: 'es'
            });

            $('.estado-select, .evaluacion-select, .sede-select, .carrera-input').on('change', actualizarGraficos);

            actualizarGraficos();

            $('#saveButton').on('click', function() {
                // Implementación de la lógica para guardar los datos.
                alert('Cambios guardados con éxito');
            });
        });
    </script>
</body>
</html>

