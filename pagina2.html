<!-- pagina2.html -->
<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Seguimiento de Prácticas Profesionales - Facultad de Humanidades</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/6.3.7/tippy.min.css">
    <style>
        body { padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dataTables_wrapper { padding: 20px 0; }
        .container-fluid { max-width: 100%; overflow-x: auto; }
        .estado-no-comienza { background-color: #ffcccc; color: #990000; }
        .estado-en-proceso { background-color: #ffffcc; color: #999900; }
        .estado-completada { background-color: #ccffcc; color: #009900; }
        .evaluacion-excelente { color: #009900; }
        .evaluacion-malo { color: #990000; }
        .chart-container { height: 300px; margin-bottom: 30px; }
        .documento-adjuntado { background-color: #ccffcc; }
        #dashboard { margin-top: 50px; }
        .dashboard-card { background-color: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .btn-volver { position: fixed; top: 20px; left: 20px; z-index: 1000; }
    </style>
</head>
<body>
    <div class='container-fluid'>
        <button id='volverButton' class='btn btn-secondary btn-volver'>Volver a página principal</button>
        <h1 class='text-center mb-4'>Seguimiento de Prácticas Profesionales - Facultad de Humanidades</h1>
        <table id='seguimientoPracticas' class='table table-striped table-bordered'>
            <thead>
                <tr>
                    <th>Nombre y Apellidos</th>
                    <th>RUT</th>
                    <th>Carrera</th>
                    <th>SEDE</th>
                    <th>Nivel de práctica</th>
                    <th>Supervisor de práctica</th>
                    <th>Centro de práctica</th>
                    <th>Nombre instructor</th>
                    <th>Fecha de Inicio</th>
                    <th>Fecha de Término</th>
                    <th>Seguimiento 1</th>
                    <th>Seguimiento 2</th>
                    <th>Evaluación instructor</th>
                    <th>Documentación instructor</th>
                    <th>Finalización práctica</th>
                    <th>Documentación finalización</th>
                    <th>Evaluación final de práctica intermedia o profesional</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas se generarán dinámicamente aquí -->
            </tbody>
        </table>
        <div class='text-center mt-3'>
            <button id='exportButton' class='btn btn-primary'>Exportar a Excel</button>
            <button id='saveButton' class='btn btn-success'>Guardar</button>
            <button id='downloadDashboardButton' class='btn btn-info'>Descargar Dashboard (PDF)</button>
        </div>
        
        <!-- Dashboard -->
        <div id='dashboard' class='row mt-5'>
            <h2 class='text-center mb-4'>Dashboard de Prácticas Profesionales</h2>
            
            <div class='col-md-4'>
                <div class='dashboard-card'>
                    <h4>Distribución por Carreras</h4>
                    <div class='chart-container'>
                        <canvas id='carrerasChart'></canvas>
                    </div>
                </div>
            </div>
            
            <div class='col-md-4'>
                <div class='dashboard-card'>
                    <h4>Distribución por Sedes</h4>
                    <div class='chart-container'>
                        <canvas id='sedesChart'></canvas>
                    </div>
                </div>
            </div>
            
            <div class='col-md-4'>
                <div class='dashboard-card'>
                    <h4>Estados de Prácticas</h4>
                    <div class='chart-container'>
                        <canvas id='estadosPracticasChart'></canvas>
                    </div>
                </div>
            </div>
            
            <div class='col-md-4'>
                <div class='dashboard-card'>
                    <h4>Evaluación Final</h4>
                    <div class='chart-container'>
                        <canvas id='evaluacionFinalChart'></canvas>
                    </div>
                </div>
            </div>
            
            <div class='col-md-4'>
                <div class='dashboard-card'>
                    <h4>Duración Promedio por Carrera</h4>
                    <div class='chart-container'>
                        <canvas id='duracionPromedioChart'></canvas>
                    </div>
                </div>
            </div>
            
            <div class='col-md-4'>
                <div class='dashboard-card'>
                    <h4>Nivel de Práctica</h4>
                    <div class='chart-container'>
                        <canvas id='nivelPracticaChart'></canvas>
                    </div>
                </div>
            </div>
            
            <div class='col-md-12'>
                <div class='dashboard-card'>
                    <h4>Estadísticas Generales</h4>
                    <div id='estadisticasGenerales'></div>
                </div>
            </div>

            <div class='col-md-6'>
                <div class='dashboard-card'>
                    <h4>Duración Promedio y Moda por Carrera</h4>
                    <div class='chart-container'>
                        <canvas id='duracionPromedioYModaChart'></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js'></script>
    <script src='https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/flatpickr'></script>
    <script src='https://npmcdn.com/flatpickr/dist/l10n/es.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/6.3.7/tippy.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        const carreras = [
            'Psicología',
            'Derecho',
            'Trabajo Social'
        ];

        const sedes = ['Ancud', 'Calama', 'Los Andes', 'San Felipe', 'Machali'];

        function crearSelectCarrera(valorSeleccionado = '') {
            return `<select class='form-select carrera-select' data-tippy-content="Selecciona la carrera del estudiante">
                ${carreras.map(carrera => `<option value='${carrera}' ${carrera === valorSeleccionado ? 'selected' : ''}>${carrera}</option>`).join('')}
            </select>`;
        }

        function crearSelectEstado(valorSeleccionado = '') {
            return `<select class='form-select estado-select' data-tippy-content="Selecciona el estado actual de la práctica">
                <option value='no-comienza' class='estado-no-comienza' ${valorSeleccionado === 'no-comienza' ? 'selected' : ''}>No comienza</option>
                <option value='en-proceso' class='estado-en-proceso' ${valorSeleccionado === 'en-proceso' ? 'selected' : ''}>En proceso</option>
                <option value='completada' class='estado-completada' ${valorSeleccionado === 'completada' ? 'selected' : ''}>Completada</option>
            </select>`;
        }

        function crearSelectEvaluacion(valorSeleccionado = '') {
            return `<select class='form-select evaluacion-select' data-tippy-content="Selecciona la evaluación del instructor">
                <option value='excelente' class='evaluacion-excelente' ${valorSeleccionado === 'excelente' ? 'selected' : ''}>Excelente</option>
                <option value='bien' ${valorSeleccionado === 'bien' ? 'selected' : ''}>Bien</option>
                <option value='suficiente' ${valorSeleccionado === 'suficiente' ? 'selected' : ''}>Suficiente</option>
                <option value='deficiente' ${valorSeleccionado === 'deficiente' ? 'selected' : ''}>Deficiente</option>
                <option value='malo' class='evaluacion-malo' ${valorSeleccionado === 'malo' ? 'selected' : ''}>Malo</option>
            </select>`;
        }

        function crearSelectSede(valorSeleccionado = '') {
            return `<select class='form-select sede-select' data-tippy-content="Selecciona la sede del estudiante">
                ${sedes.map(sede => `<option value='${sede}' ${sede === valorSeleccionado ? 'selected' : ''}>${sede}</option>`).join('')}
            </select>`;
        }

        function crearSelectNivelPractica(valorSeleccionado = '') {
            return `<select class='form-select nivel-practica-select' data-tippy-content="Selecciona el nivel de práctica">
                <option value='practica-intermedia-1' ${valorSeleccionado === 'practica-intermedia-1' ? 'selected' : ''}>Práctica Intermedia 1</option>
                <option value='practica-intermedia-2' ${valorSeleccionado === 'practica-intermedia-2' ? 'selected' : ''}>Práctica Intermedia 2</option>
                <option value='practica-profesional' ${valorSeleccionado === 'practica-profesional' ? 'selected' : ''}>Práctica Profesional</option>
            </select>`;
        }

        function generarFilas(start, end) {
            let filas = [];
            const datosGuardados = JSON.parse(localStorage.getItem('datosPracticas')) || [];

            for (let i = start; i < end; i++) {
                if (i < datosGuardados.length) {
                    filas.push(crearFila(datosGuardados[i]));
                } else {
                    filas.push(crearFila());
                }
            }
            return filas;
        }

        function crearFila(datos = {}) {
            return `
                <tr>
                    <td><input type='text' class='form-control' value='${datos.nombre || ''}' data-tippy-content="Ingresa el nombre y apellidos del estudiante"></td>
                    <td><input type='text' class='form-control' value='${datos.rut || ''}' data-tippy-content="Ingresa el RUT del estudiante"></td>
                    <td>${crearSelectCarrera(datos.carrera)}</td>
                    <td>${crearSelectSede(datos.sede)}</td>
                    <td>${crearSelectNivelPractica(datos.nivelPractica)}</td>
                    <td><input type='text' class='form-control' value='${datos.supervisorPractica || ''}' data-tippy-content="Ingresa el nombre del supervisor de práctica"></td>
                    <td><input type='text' class='form-control' value='${datos.centroPractica || ''}' data-tippy-content="Ingresa el nombre del centro de práctica"></td>
                    <td><input type='text' class='form-control' placeholder='Nombre del instructor' value='${datos.instructor || ''}' data-tippy-content="Ingresa el nombre del instructor"></td>
                    <td><input type='text' class='form-control datepicker' value='${datos.fechaInicio || ''}' data-tippy-content="Selecciona la fecha de inicio de la práctica"></td>
                    <td><input type='text' class='form-control datepicker' value='${datos.fechaTermino || ''}' data-tippy-content="Selecciona la fecha de término de la práctica"></td>
                    <td>${crearSelectEstado(datos.seguimiento1)}</td>
                    <td>${crearSelectEstado(datos.seguimiento2)}</td>
                    <td>${crearSelectEvaluacion(datos.evaluacionInstructor)}</td>
                    <td>
                        <div class="documento-container">
                            <input type="file" class="form-control adjuntar-doc" style="display: none;">
                            <button class='btn btn-primary btn-sm adjuntar-btn' data-tippy-content="Adjunta la documentación del instructor">Adjuntar documentación</button>
                            <a href="#" class="btn btn-success btn-sm descargar-doc" style="display: none;">Descargar</a>
                        </div>
                    </td>
                    <td>${crearSelectEstado(datos.finalizacionPractica)}</td>
                    <td>
                        <div class="documento-container">
                            <input type="file" class="form-control adjuntar-doc" style="display: none;">
                            <button class='btn btn-primary btn-sm adjuntar-btn' data-tippy-content="Adjunta la documentación de finalización">Adjuntar documentación</button>
                            <a href="#" class="btn btn-success btn-sm descargar-doc" style="display: none;">Descargar</a>
                        </div>
                    </td>
                    <td>${crearSelectEstado(datos.evaluacionFinal)}</td>
                </tr>
            `;
        }

        let carrerasChart, sedesChart, estadosPracticasChart, evaluacionFinalChart, duracionPromedioChart, nivelPracticaChart, duracionPromedioYModaChart;

        function actualizarDashboard() {
            actualizarGraficoCarreras();
            actualizarGraficoSedes();
            actualizarGraficoEstados();
            actualizarGraficoEvaluacionFinal();
            actualizarGraficoDuracionPromedio();
            actualizarGraficoNivelPractica();
            actualizarEstadisticasGenerales();
            actualizarEstadisticasPorCarrera();
            actualizarGraficoDuracionPromedioYModa();
        }

        function actualizarGraficoCarreras() {
            const conteoCarreras = carreras.reduce((acc, carrera) => {
                acc[carrera] = $(`#seguimientoPracticas .carrera-select option[value="${carrera}"]:selected`).length;
                return acc;
            }, {});

            if (carrerasChart) {
                carrerasChart.data.datasets[0].data = Object.values(conteoCarreras);
                carrerasChart.update();
            } else {
                const ctx = document.getElementById('carrerasChart').getContext('2d');
                carrerasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: carreras,
                        datasets: [{
                            label: 'Número de estudiantes',
                            data: Object.values(conteoCarreras),
                            backgroundColor: 'rgba(75, 192, 192, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribución por Carreras'
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoSedes() {
            const conteoSedes = sedes.reduce((acc, sede) => {
                acc[sede] = $(`#seguimientoPracticas .sede-select option[value="${sede}"]:selected`).length;
                return acc;
            }, {});

            if (sedesChart) {
                sedesChart.data.datasets[0].data = Object.values(conteoSedes);
                sedesChart.update();
            } else {
                const ctx = document.getElementById('sedesChart').getContext('2d');
                sedesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sedes,
                        datasets: [{
                            data: Object.values(conteoSedes),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribución por Sedes'
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoEstados() {
            const estados = ['en-proceso', 'completada'];
            const conteoEstados = estados.reduce((acc, estado) => {
                acc[estado] = $(`#seguimientoPracticas .estado-select option[value="${estado}"]:selected`).length;
                return acc;
            }, {});

            if (estadosPracticasChart) {
                estadosPracticasChart.data.datasets[0].data = Object.values(conteoEstados);
                estadosPracticasChart.update();
            } else {
                const ctx = document.getElementById('estadosPracticasChart').getContext('2d');
                estadosPracticasChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['En proceso', 'Completada'],
                        datasets: [{
                            data: Object.values(conteoEstados),
                            backgroundColor: ['#ffffcc', '#ccffcc']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Estados de Prácticas'
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoEvaluacionFinal() {
            const evaluaciones = ['excelente', 'bien', 'suficiente', 'deficiente', 'malo'];
            const conteoEvaluaciones = evaluaciones.reduce((acc, evaluacion) => {
                acc[evaluacion] = $(`#seguimientoPracticas .evaluacion-select option[value="${evaluacion}"]:selected`).length;
                return acc;
            }, {});

            if (evaluacionFinalChart) {
                evaluacionFinalChart.data.datasets[0].data = Object.values(conteoEvaluaciones);
                evaluacionFinalChart.update();
            } else {
                const ctx = document.getElementById('evaluacionFinalChart').getContext('2d');
                evaluacionFinalChart = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: ['Excelente', 'Bien', 'Suficiente', 'Deficiente', 'Malo'],
                        datasets: [{
                            data: Object.values(conteoEvaluaciones),
                            backgroundColor: ['#4BC0C0', '#36A2EB', '#FFCE56', '#FF9F40', '#FF6384']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Evaluación Final'
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoDuracionPromedio() {
            const duracionPorCarrera = carreras.reduce((acc, carrera) => {
                const practicas = $(`#seguimientoPracticas .carrera-select option[value="${carrera}"]:selected`).closest('tr');
                let totalDias = 0;
                let numPracticas = 0;
                
                practicas.each(function() {
                    const fechaInicio = $(this).find('td:eq(8) input').val();
                    const fechaTermino = $(this).find('td:eq(9) input').val();
                    if (fechaInicio && fechaTermino) {
                        const inicio = new Date(fechaInicio.split('/').reverse().join('-'));
                        const termino = new Date(fechaTermino.split('/').reverse().join('-'));
                        const duracion = (termino - inicio) / (1000 * 60 * 60 * 24);
                        totalDias += duracion;
                        numPracticas++;
                    }
                });
                
                acc[carrera] = numPracticas > 0 ? Math.round(totalDias / numPracticas) : 0;
                return acc;
            }, {});

            if (duracionPromedioChart) {
                duracionPromedioChart.data.datasets[0].data = Object.values(duracionPorCarrera);
                duracionPromedioChart.update();
            } else {
                const ctx = document.getElementById('duracionPromedioChart').getContext('2d');
                duracionPromedioChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: carreras,
                        datasets: [{
                            label: 'Duración promedio (días)',
                            data: Object.values(duracionPorCarrera),
                            backgroundColor: 'rgba(255, 159, 64, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Duración Promedio por Carrera'
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoNivelPractica() {
            const niveles = ['practica-intermedia-1', 'practica-intermedia-2', 'practica-profesional'];
            const conteoNiveles = niveles.reduce((acc, nivel) => {
                acc[nivel] = $(`#seguimientoPracticas .nivel-practica-select option[value="${nivel}"]:selected`).length;
                return acc;
            }, {});

            if (nivelPracticaChart) {
                nivelPracticaChart.data.datasets[0].data = Object.values(conteoNiveles);
                nivelPracticaChart.update();
            } else {
                const ctx = document.getElementById('nivelPracticaChart').getContext('2d');
                nivelPracticaChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Práctica Intermedia 1', 'Práctica Intermedia 2', 'Práctica Profesional'],
                        datasets: [{
                            data: Object.values(conteoNiveles),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Nivel de Práctica'
                            }
                        }
                    }
                });
            }
        }

        function actualizarEstadisticasGenerales() {
            const totalPracticas = $('#seguimientoPracticas tbody tr').length;
            const practicasEnProceso = $(`#seguimientoPracticas .estado-select option[value="en-proceso"]:selected`).length;
            const practicasCompletadas = $(`#seguimientoPracticas .estado-select option[value="completada"]:selected`).length;
            
            const evaluacionesExcelente = $(`#seguimientoPracticas .evaluacion-select option[value="excelente"]:selected`).length;
            const porcentajeExcelente = ((evaluacionesExcelente / totalPracticas) * 100).toFixed(2);

            const estadisticasHTML = `
                <p><strong>Total de prácticas:</strong> ${totalPracticas}</p>
                <p><strong>Prácticas en proceso:</strong> ${practicasEnProceso}</p>
                <p><strong>Prácticas completadas:</strong> ${practicasCompletadas}</p>
                <p><strong>Porcentaje de evaluaciones excelentes:</strong> ${porcentajeExcelente}%</p>
            `;

            $('#estadisticasGenerales').html(estadisticasHTML);
        }

        function actualizarEstadisticasPorCarrera() {
            const estadisticasPorCarrera = carreras.reduce((acc, carrera) => {
                const practicas = $(`#seguimientoPracticas .carrera-select option[value="${carrera}"]:selected`).closest('tr');
                const duraciones = [];
                
                practicas.each(function() {
                    const fechaInicio = $(this).find('td:eq(8) input').val();
                    const fechaTermino = $(this).find('td:eq(9) input').val();
                    if (fechaInicio && fechaTermino) {
                        const inicio = new Date(fechaInicio.split('/').reverse().join('-'));
                        const termino = new Date(fechaTermino.split('/').reverse().join('-'));
                        const duracion = (termino - inicio) / (1000 * 60 * 60 * 24);
                        duraciones.push(duracion);
                    }
                });
                
                acc[carrera] = {
                    promedio: duraciones.length > 0 ? Math.round(calcularPromedio(duraciones)) : 0,
                    moda: duraciones.length > 0 ? calcularModa(duraciones) : 0
                };
                return acc;
            }, {});

            // Actualizar la tabla de estadísticas por carrera
            let estadisticasHTML = '<table class="table table-striped"><thead><tr><th>Carrera</th><th>Duración Promedio (días)</th><th>Duración Moda (días)</th></tr></thead><tbody>';
            for (const [carrera, stats] of Object.entries(estadisticasPorCarrera)) {
                estadisticasHTML += `<tr><td>${carrera}</td><td>${stats.promedio}</td><td>${stats.moda}</td></tr>`;
            }
            estadisticasHTML += '</tbody></table>';
            $('#estadisticasPorCarrera').html(estadisticasHTML);
        }

        function actualizarGraficoDuracionPromedioYModa() {
            const estadisticasPorCarrera = carreras.reduce((acc, carrera) => {
                const practicas = $(`#seguimientoPracticas .carrera-select option[value="${carrera}"]:selected`).closest('tr');
                const duraciones = [];
                
                practicas.each(function() {
                    const fechaInicio = $(this).find('td:eq(8) input').val();
                    const fechaTermino = $(this).find('td:eq(9) input').val();
                    if (fechaInicio && fechaTermino) {
                        const inicio = new Date(fechaInicio.split('/').reverse().join('-'));
                        const termino = new Date(fechaTermino.split('/').reverse().join('-'));
                        const duracion = (termino - inicio) / (1000 * 60 * 60 * 24);
                        duraciones.push(duracion);
                    }
                });
                
                acc[carrera] = {
                    promedio: duraciones.length > 0 ? Math.round(calcularPromedio(duraciones)) : 0,
                    moda: duraciones.length > 0 ? calcularModa(duraciones) : 0
                };
                return acc;
            }, {});

            if (duracionPromedioYModaChart) {
                duracionPromedioYModaChart.data.datasets[0].data = carreras.map(carrera => estadisticasPorCarrera[carrera].promedio);
                duracionPromedioYModaChart.data.datasets[1].data = carreras.map(carrera => estadisticasPorCarrera[carrera].moda);
                duracionPromedioYModaChart.update();
            } else {
                const ctx = document.getElementById('duracionPromedioYModaChart').getContext('2d');
                duracionPromedioYModaChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: carreras,
                        datasets: [
                            {
                                label: 'Duración Promedio',
                                data: carreras.map(carrera => estadisticasPorCarrera[carrera].promedio),
                                backgroundColor: 'rgba(75, 192, 192, 0.6)'
                            },
                            {
                                label: 'Duración Moda',
                                data: carreras.map(carrera => estadisticasPorCarrera[carrera].moda),
                                backgroundColor: 'rgba(255, 159, 64, 0.6)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Días'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Duración Promedio y Moda por Carrera'
                            }
                        }
                    }
                });
            }
        }

        // Función para calcular la moda
        function calcularModa(arr) {
            return arr.sort((a,b) =>
                arr.filter(v => v===a).length - arr.filter(v => v===b).length
            ).pop();
        }

        // Función para calcular el promedio
        function calcularPromedio(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        $(document).ready(function() {
            let table = $('#seguimientoPracticas').DataTable({
                scrollX: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json'
                },
                dom: 'Bfrtip',
                buttons: [],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                processing: true,
                serverSide: true,
                ajax: function (data, callback, settings) {
                    const start = data.start;
                    const end = data.start + data.length;
                    const filas = generarFilas(start, end);
                    callback({
                        draw: data.draw,
                        recordsTotal: 500,
                        recordsFiltered: 500,
                        data: filas
                    });
                },
                columns: [
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(0)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(1)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(2)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(3)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(4)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(5)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(6)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(7)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(8)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(9)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(10)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(11)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(12)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(13)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(14)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(15)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(16)').html(); } }
                ],
                drawCallback: function() {
                    $('.datepicker').flatpickr({
                        locale: 'es',
                        dateFormat: 'd/m/Y'
                    });
                    tippy('[data-tippy-content]');
                    actualizarDashboard();
                }
            });

            $('#seguimientoPracticas').on('change', '.adjuntar-doc', function(e) {
                const file = e.target.files[0];
                const container = $(this).closest('.documento-container');
                const descargarBtn = container.find('.descargar-doc');
                
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64Data = e.target.result;
                        container.data('file', { name: file.name, data: base64Data });
                        descargarBtn.show().attr('href', base64Data).attr('download', file.name);
                    };
                    reader.readAsDataURL(file);
                }
            });

            $('#seguimientoPracticas').on('click', '.adjuntar-btn', function() {
                $(this).siblings('.adjuntar-doc').click();
            });

            $('#exportButton').on('click', function() {
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.table_to_sheet(document.getElementById('seguimientoPracticas'));
                
                // Filtrar solo las filas modificadas por el usuario
                const modifiedRows = [];
                $('#seguimientoPracticas tbody tr').each(function(index) {
                    const $row = $(this);
                    const isModified = $row.find('input, select').toArray().some(el => el.value !== '');
                    if (isModified) {
                        const rowData = [];
                        $row.find('td').each(function() {
                            const $cell = $(this);
                            const $input = $cell.find('input');
                            const $select = $cell.find('select');
                            if ($input.length) {
                                rowData.push($input.val());
                            } else if ($select.length) {
                                rowData.push($select.val());
                            } else {
                                rowData.push($cell.text());
                            }
                        });
                        modifiedRows.push(rowData);
                    }
                });

                const modifiedWorksheet = XLSX.utils.aoa_to_sheet([
                    ['Nombre y Apellidos', 'RUT', 'Carrera', 'SEDE', 'Nivel de práctica', 'Supervisor de práctica', 'Centro de práctica', 'Nombre instructor', 'Fecha de Inicio', 'Fecha de Término', 'Seguimiento 1', 'Seguimiento 2', 'Evaluación instructor', 'Documentación instructor', 'Finalización práctica', 'Documentación finalización', 'Evaluación final de práctica intermedia o profesional'],
                    ...modifiedRows
                ]);

                XLSX.utils.book_append_sheet(workbook, modifiedWorksheet, 'Datos modificados');
                XLSX.writeFile(workbook, 'seguimiento_practicas_modificados.xlsx');
            });

            $('#saveButton').on('click', function() {
                const datos = [];
                $('#seguimientoPracticas tbody tr').each(function() {
                    const $row = $(this);
                    const rowData = {
                        nombre: $row.find('td:eq(0) input').val(),
                        rut: $row.find('td:eq(1) input').val(),
                        carrera: $row.find('td:eq(2) select').val(),
                        sede: $row.find('td:eq(3) select').val(),
                        nivelPractica: $row.find('td:eq(4) select').val(),
                        supervisorPractica: $row.find('td:eq(5) input').val(),
                        centroPractica: $row.find('td:eq(6) input').val(),
                        instructor: $row.find('td:eq(7) input').val(),
                        fechaInicio: $row.find('td:eq(8) input').val(),
                        fechaTermino: $row.find('td:eq(9) input').val(),
                        seguimiento1: $row.find('td:eq(10) select').val(),
                        seguimiento2: $row.find('td:eq(11) select').val(),
                        evaluacionInstructor: $row.find('td:eq(12) select').val(),
                        documentacionInstructor: $row.find('td:eq(13) .documento-container').data('file'),
                        finalizacionPractica: $row.find('td:eq(14) select').val(),
                        documentacionFinalizacion: $row.find('td:eq(15) .documento-container').data('file'),
                        evaluacionFinal: $row.find('td:eq(16) select').val()
                    };
                    datos.push(rowData);
                });
                localStorage.setItem('datosPracticas', JSON.stringify(datos));
                alert('Datos guardados correctamente');
                actualizarDashboard();
            });

            // Evento para actualizar el dashboard cuando cambie cualquier dato en la tabla
            $('#seguimientoPracticas').on('change', 'input, select', function() {
                actualizarDashboard();
            });

            // Inicializar el dashboard
            actualizarDashboard();

            // Botón para volver a la página principal
            $('#volverButton').on('click', function() {
                window.location.href = 'https://kilua2x.github.io/PRACTICAS/'; // Asegúrate de que esta sea la URL correcta de tu página principal
            });

            // Botón para descargar el dashboard en PDF
            $('#downloadDashboardButton').on('click', function() {
                html2canvas(document.querySelector("#dashboard")).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF();
                    const imgProps= pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save("dashboard.pdf");
                });
            });
        });
    </script>
</body>
</html>
