<!-- pagina3.html -->
<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Seguimiento de Prácticas Profesionales - Facultad de Salud</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css' rel='stylesheet'>
    <style>
        body { padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dataTables_wrapper { padding: 20px 0; }
        .container-fluid { max-width: 100%; overflow-x: auto; }
        .estado-no-comienza { background-color: #ffcccc; color: #990000; }
        .estado-en-proceso { background-color: #ffffcc; color: #999900; }
        .estado-completada { background-color: #ccffcc; color: #009900; }
        .evaluacion-excelente { color: #009900; }
        .evaluacion-malo { color: #990000; }
        .chart-container { height: 300px; margin-bottom: 30px; }
        .documento-adjuntado { background-color: #ccffcc; }
        #dashboard { margin-top: 50px; }
        .stat-card { background-color: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .stat-card h3 { font-size: 18px; margin-bottom: 10px; }
        .stat-card p { font-size: 24px; font-weight: bold; margin: 0; }
    </style>
</head>
<body>
    <div class='container-fluid'>
        <h1 class='text-center mb-4'>Seguimiento de Prácticas Profesionales - Facultad de Salud</h1>
        <table id='seguimientoPracticas' class='table table-striped table-bordered'>
            <thead>
                <tr>
                    <th>Nombre y Apellidos</th>
                    <th>RUT</th>
                    <th>Carrera</th>
                    <th>SEDE</th>
                    <th>Nivel de práctica</th>
                    <th>Supervisor de práctica</th>
                    <th>Campo Clínico</th>
                    <th>Servicio y complejidad</th>
                    <th>Nombre instructor</th>
                    <th>Fecha de Inicio</th>
                    <th>Fecha de Término</th>
                    <th>Seguimiento 1</th>
                    <th>Seguimiento 2</th>
                    <th>Evaluación instructor</th>
                    <th>Documentación instructor</th>
                    <th>Finalización práctica</th>
                    <th>Documentación finalización</th>
                    <th>Evaluación final de práctica profesional</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas se generarán dinámicamente aquí -->
            </tbody>
        </table>
        <div class='text-center mt-3'>
            <button id='exportButton' class='btn btn-primary'>Exportar a Excel</button>
            <button id='saveButton' class='btn btn-success'>Guardar</button>
        </div>
        
        <div id='dashboard' class='row mt-5'>
            <h2 class='text-center mb-4'>Dashboard de Prácticas Profesionales</h2>
            <div class='col-md-4'>
                <div class='stat-card'>
                    <h3>Total de Prácticas</h3>
                    <p id='totalPracticas'>0</p>
                </div>
            </div>
            <div class='col-md-4'>
                <div class='stat-card'>
                    <h3>Prácticas en Proceso</h3>
                    <p id='practicasEnProceso'>0</p>
                </div>
            </div>
            <div class='col-md-4'>
                <div class='stat-card'>
                    <h3>Prácticas Completadas</h3>
                    <p id='practicasCompletadas'>0</p>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='chart-container'>
                    <canvas id='estadosPracticasChart'></canvas>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='chart-container'>
                    <canvas id='carrerasChart'></canvas>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='chart-container'>
                    <canvas id='sedesChart'></canvas>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='chart-container'>
                    <canvas id='evaluacionInstructorChart'></canvas>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='chart-container'>
                    <canvas id='promedioPracticasChart'></canvas>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='chart-container'>
                    <canvas id='modaPracticasChart'></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <script src='https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js'></script>
    <script src='https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js'></script>
    <script src='https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/flatpickr'></script>
    <script src='https://npmcdn.com/flatpickr/dist/l10n/es.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js'></script>

    <script>
        const carreras = [
            'Enfermería',
            'Kinesiología',
            'Técnico Nivel Superior en Enfermería',
            'Terapia Ocupacional'
        ];

        const sedes = ['Ancud', 'Calama', 'Los Andes', 'San Felipe', 'Machali'];

        function crearSelectCarrera(valorSeleccionado = '') {
            return `<select class='form-select carrera-select'>
                ${carreras.map(carrera => `<option value='${carrera}' ${carrera === valorSeleccionado ? 'selected' : ''}>${carrera}</option>`).join('')}
            </select>`;
        }

        function crearSelectEstado(valorSeleccionado = '') {
            return `<select class='form-select estado-select'>
                <option value='no-comienza' class='estado-no-comienza' ${valorSeleccionado === 'no-comienza' ? 'selected' : ''}>No comienza</option>
                <option value='en-proceso' class='estado-en-proceso' ${valorSeleccionado === 'en-proceso' ? 'selected' : ''}>En proceso</option>
                <option value='completada' class='estado-completada' ${valorSeleccionado === 'completada' ? 'selected' : ''}>Completada</option>
            </select>`;
        }

        function crearSelectEvaluacion(valorSeleccionado = '') {
            return `<select class='form-select evaluacion-select'>
                <option value='excelente' class='evaluacion-excelente' ${valorSeleccionado === 'excelente' ? 'selected' : ''}>Excelente</option>
                <option value='bien' ${valorSeleccionado === 'bien' ? 'selected' : ''}>Bien</option>
                <option value='suficiente' ${valorSeleccionado === 'suficiente' ? 'selected' : ''}>Suficiente</option>
                <option value='deficiente' ${valorSeleccionado === 'deficiente' ? 'selected' : ''}>Deficiente</option>
                <option value='malo' class='evaluacion-malo' ${valorSeleccionado === 'malo' ? 'selected' : ''}>Malo</option>
            </select>`;
        }

        function crearSelectSede(valorSeleccionado = '') {
            return `<select class='form-select sede-select'>
                ${sedes.map(sede => `<option value='${sede}' ${sede === valorSeleccionado ? 'selected' : ''}>${sede}</option>`).join('')}
            </select>`;
        }

        function crearSelectNivelPractica(valorSeleccionado = '') {
            return `<select class='form-select nivel-practica-select'>
                ${[1, 2, 3, 4, 5].map(nivel => `<option value='${nivel}' ${nivel == valorSeleccionado ? 'selected' : ''}>${nivel}</option>`).join('')}
            </select>`;
        }

        function generarFilas(start, end) {
            let filas = [];
            const datosGuardados = JSON.parse(localStorage.getItem('datosPracticas')) || [];

            for (let i = start; i < end; i++) {
                if (i < datosGuardados.length) {
                    filas.push(crearFila(datosGuardados[i]));
                } else {
                    filas.push(crearFila());
                }
            }
            return filas;
        }

        function crearFila(datos = {}) {
            return `
                <tr>
                    <td><input type='text' class='form-control' value='${datos.nombre || ''}'></td>
                    <td><input type='text' class='form-control' value='${datos.rut || ''}'></td>
                    <td>${crearSelectCarrera(datos.carrera)}</td>
                    <td>${crearSelectSede(datos.sede)}</td>
                    <td>${crearSelectNivelPractica(datos.nivelPractica)}</td>
                    <td><input type='text' class='form-control' value='${datos.supervisorPractica || ''}'></td>
                    <td><input type='text' class='form-control' value='${datos.campoClinico || ''}'></td>
                    <td><input type='text' class='form-control' value='${datos.servicioComplejidad || ''}'></td>
                    <td><input type='text' class='form-control' placeholder='Nombre del instructor' value='${datos.instructor || ''}'></td>
                    <td><input type='text' class='form-control datepicker' value='${datos.fechaInicio || ''}'></td>
                    <td><input type='text' class='form-control datepicker' value='${datos.fechaTermino || ''}'></td>
                    <td>${crearSelectEstado(datos.seguimiento1)}</td>
                    <td>${crearSelectEstado(datos.seguimiento2)}</td>
                    <td>${crearSelectEvaluacion(datos.evaluacionInstructor)}</td>
                    <td>
                        <div class="documento-container">
                            <input type="file" class="form-control adjuntar-doc" style="display: none;">
                            <button class='btn btn-primary btn-sm adjuntar-btn'>Adjuntar documentación</button>
                            <a href="#" class="btn btn-success btn-sm descargar-doc" style="display: none;">Descargar</a>
                        </div>
                    </td>
                    <td>${crearSelectEstado(datos.finalizacionPractica)}</td>
                    <td>
                        <div class="documento-container">
                            <input type="file" class="form-control adjuntar-doc" style="display: none;">
                            <button class='btn btn-primary btn-sm adjuntar-btn'>Adjuntar documentación</button>
                            <a href="#" class="btn btn-success btn-sm descargar-doc" style="display: none;">Descargar</a>
                        </div>
                    </td>
                    <td>${crearSelectEstado(datos.evaluacionFinal)}</td>
                </tr>
            `;
        }

        let estadosChart, carrerasChart, sedesChart, evaluacionInstructorChart, promedioPracticasChart, modaPracticasChart;

        function actualizarDashboard() {
            actualizarEstadisticas();
            actualizarGraficoEstados();
            actualizarGraficoCarreras();
            actualizarGraficoSedes();
            actualizarGraficoEvaluacionInstructor();
            actualizarGraficoPromedioPracticas();
            actualizarGraficoModaPracticas();
        }

        function actualizarEstadisticas() {
            let totalPracticas = 0;
            let practicasEnProceso = 0;
            let practicasCompletadas = 0;

            $('#seguimientoPracticas tbody tr').each(function() {
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza') {
                    totalPracticas++;
                    if (estado === 'en-proceso') {
                        practicasEnProceso++;
                    } else if (estado === 'completada') {
                        practicasCompletadas++;
                    }
                }
            });

            $('#totalPracticas').text(totalPracticas);
            $('#practicasEnProceso').text(practicasEnProceso);
            $('#practicasCompletadas').text(practicasCompletadas);
        }

        function actualizarGraficoEstados() {
            let conteoEstados = {
                'en-proceso': 0,
                'completada': 0
            };

            $('#seguimientoPracticas tbody tr').each(function() {
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza') {
                    conteoEstados[estado]++;
                }
            });

            const datos = Object.values(conteoEstados);
            const colores = ['#ffffcc', '#ccffcc'];

            if (estadosChart) {
                estadosChart.data.datasets[0].data = datos;
                estadosChart.update();
            } else {
                const ctx = document.getElementById('estadosPracticasChart').getContext('2d');
                estadosChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['En proceso', 'Completada'],
                        datasets: [{
                            data: datos,
                            backgroundColor: colores
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Estados de las Prácticas'
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoCarreras() {
            let conteoCarreras = {};
            carreras.forEach(carrera => conteoCarreras[carrera] = 0);

            $('#seguimientoPracticas tbody tr').each(function() {
                let carrera = $(this).find('td:eq(2) select').val();
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza' && conteoCarreras[carrera] !== undefined) {
                    conteoCarreras[carrera]++;
                }
            });

            const datos = carreras.map(carrera => conteoCarreras[carrera]);
            const colores = datos.map(() => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`);

            if (carrerasChart) {
                carrerasChart.data.datasets[0].data = datos;
                carrerasChart.data.datasets[0].backgroundColor = colores;
                carrerasChart.update();
            } else {
                const ctx = document.getElementById('carrerasChart').getContext('2d');
                carrerasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: carreras,
                        datasets: [{
                            label: 'Número de Estudiantes por Carrera',
                            data: datos,
                            backgroundColor: colores
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Distribución de Estudiantes por Carrera'
                            }
                        },
                        scales: {
                            x: { 
                                title: { display: true, text: 'Carreras' },
                                ticks: { 
                                    autoSkip: false,
                                    maxRotation: 90,
                                    minRotation: 90
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Número de Estudiantes' }
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoSedes() {
            let conteoSedes = {};
            sedes.forEach(sede => conteoSedes[sede] = 0);

            $('#seguimientoPracticas tbody tr').each(function() {
                let sede = $(this).find('td:eq(3) select').val();
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza' && conteoSedes[sede] !== undefined) {
                    conteoSedes[sede]++;
                }
            });

            const datos = sedes.map(sede => conteoSedes[sede]);
            const colores = datos.map(() => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`);

            if (sedesChart) {
                sedesChart.data.datasets[0].data = datos;
                sedesChart.data.datasets[0].backgroundColor = colores;
                sedesChart.update();
            } else {
                const ctx = document.getElementById('sedesChart').getContext('2d');
                sedesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sedes,
                        datasets: [{
                            data: datos,
                            backgroundColor: colores
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Distribución por Sedes'
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoEvaluacionInstructor() {
            let conteoEvaluacion = {
                'excelente': 0,
                'bien': 0,
                'suficiente': 0,
                'deficiente': 0,
                'malo': 0
            };

            $('#seguimientoPracticas tbody tr').each(function() {
                let evaluacion = $(this).find('td:eq(13) select').val();
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza' && conteoEvaluacion[evaluacion] !== undefined) {
                    conteoEvaluacion[evaluacion]++;
                }
            });

            const datos = Object.values(conteoEvaluacion);
            const colores = ['#4CAF50', '#8BC34A', '#FFC107', '#FF9800', '#F44336'];

            if (evaluacionInstructorChart) {
                evaluacionInstructorChart.data.datasets[0].data = datos;
                evaluacionInstructorChart.update();
            } else {
                const ctx = document.getElementById('evaluacionInstructorChart').getContext('2d');
                evaluacionInstructorChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Excelente', 'Bien', 'Suficiente', 'Deficiente', 'Malo'],
                        datasets: [{
                            data: datos,
                            backgroundColor: colores
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Evaluación del Instructor'
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoPromedioPracticas() {
            let sumaPracticas = {};
            let conteoCarreras = {};
            carreras.forEach(carrera => {
                sumaPracticas[carrera] = 0;
                conteoCarreras[carrera] = 0;
            });

            $('#seguimientoPracticas tbody tr').each(function() {
                let carrera = $(this).find('td:eq(2) select').val();
                let nivelPractica = parseInt($(this).find('td:eq(4) select').val());
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza' && !isNaN(nivelPractica)) {
                    sumaPracticas[carrera] += nivelPractica;
                    conteoCarreras[carrera]++;
                }
            });

            const promedios = carreras.map(carrera => 
                conteoCarreras[carrera] > 0 ? sumaPracticas[carrera] / conteoCarreras[carrera] : 0
            );

            if (promedioPracticasChart) {
                promedioPracticasChart.data.datasets[0].data = promedios;
                promedioPracticasChart.update();
            } else {
                const ctx = document.getElementById('promedioPracticasChart').getContext('2d');
                promedioPracticasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: carreras,
                        datasets: [{
                            label: 'Promedio de Nivel de Práctica',
                            data: promedios,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Promedio de Nivel de Práctica por Carrera'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Promedio de Nivel'
                                }
                            }
                        }
                    }
                });
            }
        }

        function actualizarGraficoModaPracticas() {
            let modaPracticas = {};
            carreras.forEach(carrera => {
                modaPracticas[carrera] = {};
            });

            $('#seguimientoPracticas tbody tr').each(function() {
                let carrera = $(this).find('td:eq(2) select').val();
                let nivelPractica = parseInt($(this).find('td:eq(4) select').val());
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza' && !isNaN(nivelPractica)) {
                    modaPracticas[carrera][nivelPractica] = (modaPracticas[carrera][nivelPractica] || 0) + 1;
                }
            });

            const modas = carreras.map(carrera => {
                let max = 0;
                let moda = 0;
                for (let nivel in modaPracticas[carrera]) {
                    if (modaPracticas[carrera][nivel] > max) {
                        max = modaPracticas[carrera][nivel];
                        moda = parseInt(nivel);
                    }
                }
                return moda;
            });

            if (modaPracticasChart) {
                modaPracticasChart.data.datasets[0].data = modas;
                modaPracticasChart.update();
            } else {
                const ctx = document.getElementById('modaPracticasChart').getContext('2d');
                modaPracticasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: carreras,
                        datasets: [{
                            label: 'Moda de Nivel de Práctica',
                            data: modas,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Moda de Nivel de Práctica por Carrera'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Moda de Nivel'
                                },
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        }

        $(document).ready(function() {
            let table = $('#seguimientoPracticas').DataTable({
                scrollX: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json'
                },
                dom: 'Bfrtip',
                buttons: [],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                processing: true,
                serverSide: true,
                ajax: function (data, callback, settings) {
                    const start = data.start;
                    const end = data.start + data.length;
                    const filas = generarFilas(start, end);
                    callback({
                        draw: data.draw,
                        recordsTotal: 500,
                        recordsFiltered: 500,
                        data: filas
                    });
                },
                columns: [
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(0)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(1)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(2)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(3)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(4)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(5)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(6)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(7)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(8)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(9)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(10)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(11)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(12)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(13)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(14)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(15)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(16)').html(); } },
                    { data: null, render: function (data, type, row) { return $(row).find('td:eq(17)').html(); } }
                ],
                drawCallback: function() {
                    $('.datepicker').flatpickr({
                        locale: 'es',
                        dateFormat: 'd/m/Y'
                    });

                    $('.adjuntar-btn').off('click').on('click', function() {
                        $(this).siblings('.adjuntar-doc').click();
                    });

                    $$('.adjuntar-doc').off('change').on('change', function() {
                        if (this.files && this.files[0]) {
                            $(this).closest('.documento-container').addClass('documento-adjuntado');
                            $(this).siblings('.descargar-doc').show();
                            $(this).siblings('.adjuntar-btn').text('Cambiar documento');
                        }
                    });

                    $('.descargar-doc').off('click').on('click', function(e) {
                        e.preventDefault();
                        alert('Función de descarga no implementada en este ejemplo.');
                    });

                    actualizarDashboard();
                }
            });

            $('#exportButton').on('click', function() {
                let data = [];
                table.rows().every(function() {
                    let row = [];
                    $(this.node()).find('td').each(function() {
                        if ($(this).find('select').length) {
                            row.push($(this).find('select').val());
                        } else if ($(this).find('input[type="text"]').length) {
                            row.push($(this).find('input[type="text"]').val());
                        } else {
                            row.push($(this).text());
                        }
                    });
                    data.push(row);
                });

                let ws = XLSX.utils.aoa_to_sheet([
                    ['Nombre y Apellidos', 'RUT', 'Carrera', 'SEDE', 'Nivel de práctica', 'Supervisor de práctica', 'Campo Clínico', 'Servicio y complejidad', 'Nombre instructor', 'Fecha de Inicio', 'Fecha de Término', 'Seguimiento 1', 'Seguimiento 2', 'Evaluación instructor', 'Documentación instructor', 'Finalización práctica', 'Documentación finalización', 'Evaluación final de práctica profesional'],
                    ...data
                ]);
                let wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Practicas');
                XLSX.writeFile(wb, 'Seguimiento_Practicas.xlsx');
            });

            $('#saveButton').on('click', function() {
                let data = [];
                table.rows().every(function() {
                    let rowData = {};
                    $(this.node()).find('td').each(function(index) {
                        if ($(this).find('select').length) {
                            rowData[table.column(index).header().textContent] = $(this).find('select').val();
                        } else if ($(this).find('input[type="text"]').length) {
                            rowData[table.column(index).header().textContent] = $(this).find('input[type="text"]').val();
                        } else {
                            rowData[table.column(index).header().textContent] = $(this).text();
                        }
                    });
                    data.push(rowData);
                });
                localStorage.setItem('datosPracticas', JSON.stringify(data));
                alert('Datos guardados correctamente');
            });

            // Evento para actualizar el dashboard cuando se cambia algún valor en la tabla
            $('#seguimientoPracticas').on('change', 'select, input', function() {
                actualizarDashboard();
            });

            // Inicializar el dashboard
            actualizarDashboard();
        });

        // Función para actualizar las estadísticas generales
        function actualizarEstadisticasGenerales() {
            let totalPracticas = 0;
            let practicasEnProceso = 0;
            let practicasCompletadas = 0;

            $('#seguimientoPracticas tbody tr').each(function() {
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza') {
                    totalPracticas++;
                    if (estado === 'en-proceso') {
                        practicasEnProceso++;
                    } else if (estado === 'completada') {
                        practicasCompletadas++;
                    }
                }
            });

            $('#totalPracticas').text(totalPracticas);
            $('#practicasEnProceso').text(practicasEnProceso);
            $('#practicasCompletadas').text(practicasCompletadas);
        }

        // Función para calcular el promedio de prácticas por carrera
        function calcularPromedioPracticasPorCarrera() {
            let sumaPracticas = {};
            let conteoCarreras = {};
            carreras.forEach(carrera => {
                sumaPracticas[carrera] = 0;
                conteoCarreras[carrera] = 0;
            });

            $('#seguimientoPracticas tbody tr').each(function() {
                let carrera = $(this).find('td:eq(2) select').val();
                let nivelPractica = parseInt($(this).find('td:eq(4) select').val());
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza' && !isNaN(nivelPractica)) {
                    sumaPracticas[carrera] += nivelPractica;
                    conteoCarreras[carrera]++;
                }
            });

            let promedios = {};
            carreras.forEach(carrera => {
                promedios[carrera] = conteoCarreras[carrera] > 0 ? sumaPracticas[carrera] / conteoCarreras[carrera] : 0;
            });

            return promedios;
        }

        // Función para calcular la moda de prácticas por carrera
        function calcularModaPracticasPorCarrera() {
            let modaPracticas = {};
            carreras.forEach(carrera => {
                modaPracticas[carrera] = {};
            });

            $('#seguimientoPracticas tbody tr').each(function() {
                let carrera = $(this).find('td:eq(2) select').val();
                let nivelPractica = parseInt($(this).find('td:eq(4) select').val());
                let estado = $(this).find('td:eq(15) select').val();
                if (estado !== 'no-comienza' && !isNaN(nivelPractica)) {
                    modaPracticas[carrera][nivelPractica] = (modaPracticas[carrera][nivelPractica] || 0) + 1;
                }
            });

            let modas = {};
            carreras.forEach(carrera => {
                let max = 0;
                let moda = 0;
                for (let nivel in modaPracticas[carrera]) {
                    if (modaPracticas[carrera][nivel] > max) {
                        max = modaPracticas[carrera][nivel];
                        moda = parseInt(nivel);
                    }
                }
                modas[carrera] = moda;
            });

            return modas;
        }

        // Función para actualizar todos los gráficos
        function actualizarTodosLosGraficos() {
            actualizarGraficoEstados();
            actualizarGraficoCarreras();
            actualizarGraficoSedes();
            actualizarGraficoEvaluacionInstructor();
            actualizarGraficoPromedioPracticas();
            actualizarGraficoModaPracticas();
        }

        // Llamar a esta función cuando se carga la página y cuando se realiza algún cambio en la tabla
        function actualizarDashboardCompleto() {
            actualizarEstadisticasGenerales();
            actualizarTodosLosGraficos();
        }

        // Agregar evento para actualizar el dashboard cuando se cambia algún valor en la tabla
        $('#seguimientoPracticas').on('change', 'select, input', function() {
            actualizarDashboardCompleto();
        });

        // Inicializar el dashboard al cargar la página
        $(document).ready(function() {
            actualizarDashboardCompleto();
        });
    </script>
</body>
</html>
